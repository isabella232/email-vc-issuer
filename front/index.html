<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>Page Title</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
</head>
<body>
  <h1>Email VC Issuer client</h1>

  <h3>1. Enable wallet</h3>
  <button id="enable">enable</button>
  <p id="account"></p>
  <p id="did"></p>

  <h3>2. Request email verification</h3>
  <input type="email" id="email" disabled />
  <button id="request" disabled>request</button>
  <p id="result"></p>

  <h3>3. Verify your email</h3>
  <input type="text" id="code" disabled />
  <button id="verify" disabled>verify</button>

  <p id="jwt"></p>

  <script>
    const enableEl = document.getElementById('enable')

    enableEl.addEventListener('click', () => {
      window.ethereum.enable()
        .then(accounts => {
          const account = accounts[0].toLowerCase()
          const did = `did:ethr:rsk:${account}`

          document.getElementById('account').innerHTML = account
          document.getElementById('did').innerHTML = did

          const emailEl = document.getElementById('email')
          const requestEl = document.getElementById('request')

          emailEl.removeAttribute('disabled')
          requestEl.removeAttribute('disabled')

          requestEl.addEventListener('click', () => {
            const emailAddress = emailEl.value

            fetch('http://localhost:3500/requestVerification/' + did, {
              method: 'POST',
              mode: 'cors',
              cache: 'no-cache',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json'
              },
              redirect: 'follow',
              referrerPolicy: 'no-referrer',
              body: JSON.stringify({ emailAddress })
            }).then(() => {
              document.getElementById('result').innerHTML = 'Check terminal to verify email via url'

              const codeEl = document.getElementById('code')
              const verifyEl = document.getElementById('verify')

              codeEl.removeAttribute('disabled')
              verifyEl.removeAttribute('disabled')

              verifyEl.addEventListener('click', () => {
                const verificationCode = codeEl.value

                window.ethereum.request({
                  method: 'personal_sign',
                  params: [
                    account,
                    `Verification code: ${verificationCode}`
                  ]
                }).then(sig => fetch('http://localhost:3500/verify/' + did, {
                  method: 'POST',
                  mode: 'cors',
                  cache: 'no-cache',
                  credentials: 'same-origin',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  redirect: 'follow',
                  referrerPolicy: 'no-referrer',
                  body: JSON.stringify({ sig })
                })).then(res => res.json()).then(({ jwt }) => {
                  document.getElementById('jwt').innerHTML = jwt
                })
              })
            })
          })
        })
    })
  </script>
</body>
</html>
